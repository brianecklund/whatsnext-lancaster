{"version":3,"file":"index.js","sources":["../../../../../../../../../node_modules/@sentry/node/esm/integrations/undici/index.js"],"sourcesContent":["import { _optionalChain } from '@sentry/utils';\nimport { defineIntegration, hasTracingEnabled, getClient, isSentryRequestUrl, getCurrentScope, getIsolationScope, getActiveSpan, spanToTraceHeader, getDynamicSamplingContextFromSpan, getDynamicSamplingContextFromClient, setHttpStatus, addBreadcrumb } from '@sentry/core';\nimport { LRUMap, generateSentryTraceHeader, dynamicSamplingContextToSentryBaggageHeader, parseUrl, stringMatchesSomePattern, getSanitizedUrlString } from '@sentry/utils';\nimport { NODE_VERSION } from '../../nodeVersion.js';\n\nvar ChannelName;(function (ChannelName) {\n  // https://github.com/nodejs/undici/blob/e6fc80f809d1217814c044f52ed40ef13f21e43c/docs/api/DiagnosticsChannel.md#undicirequestcreate\n  const RequestCreate = 'undici:request:create'; ChannelName[\"RequestCreate\"] = RequestCreate;\n  const RequestEnd = 'undici:request:headers'; ChannelName[\"RequestEnd\"] = RequestEnd;\n  const RequestError = 'undici:request:error'; ChannelName[\"RequestError\"] = RequestError;\n})(ChannelName || (ChannelName = {}));\n\n// Please note that you cannot use `console.log` to debug the callbacks registered to the `diagnostics_channel` API.\n// To debug, you can use `writeFileSync` to write to a file:\n// https://nodejs.org/api/async_hooks.html#printing-in-asynchook-callbacks\n//\n// import { writeFileSync } from 'fs';\n// import { format } from 'util';\n//\n// function debug(...args: any): void {\n//   // Use a function like this one when debugging inside an AsyncHook callback\n//   // @ts-expect-error any\n//   writeFileSync('log.out', `${format(...args)}\\n`, { flag: 'a' });\n// }\n\nconst _nativeNodeFetchintegration = ((options) => {\n  // eslint-disable-next-line deprecation/deprecation\n  return new Undici(options) ;\n}) ;\n\nconst nativeNodeFetchintegration = defineIntegration(_nativeNodeFetchintegration);\n\n/**\n * Instruments outgoing HTTP requests made with the `undici` package via\n * Node's `diagnostics_channel` API.\n *\n * Supports Undici 4.7.0 or higher.\n *\n * Requires Node 16.17.0 or higher.\n *\n * @deprecated Use `nativeNodeFetchintegration()` instead.\n */\nclass Undici  {\n  /**\n   * @inheritDoc\n   */\n   static __initStatic() {this.id = 'Undici';}\n\n  /**\n   * @inheritDoc\n   */\n  // eslint-disable-next-line deprecation/deprecation\n   __init() {this.name = Undici.id;}\n\n    __init2() {this._createSpanUrlMap = new LRUMap(100);}\n    __init3() {this._headersUrlMap = new LRUMap(100);}\n\n   constructor(_options = {}) {Undici.prototype.__init.call(this);Undici.prototype.__init2.call(this);Undici.prototype.__init3.call(this);Undici.prototype.__init4.call(this);Undici.prototype.__init5.call(this);Undici.prototype.__init6.call(this);\n    this._options = {\n      breadcrumbs: _options.breadcrumbs === undefined ? true : _options.breadcrumbs,\n      tracing: _options.tracing,\n      shouldCreateSpanForRequest: _options.shouldCreateSpanForRequest,\n    };\n  }\n\n  /**\n   * @inheritDoc\n   */\n   setupOnce(_addGlobalEventProcessor) {\n    // Requires Node 16+ to use the diagnostics_channel API.\n    if (NODE_VERSION.major < 16) {\n      return;\n    }\n\n    let ds;\n    try {\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      ds = require('diagnostics_channel') ;\n    } catch (e) {\n      // no-op\n    }\n\n    if (!ds || !ds.subscribe) {\n      return;\n    }\n\n    // https://github.com/nodejs/undici/blob/e6fc80f809d1217814c044f52ed40ef13f21e43c/docs/api/DiagnosticsChannel.md\n    ds.subscribe(ChannelName.RequestCreate, this._onRequestCreate);\n    ds.subscribe(ChannelName.RequestEnd, this._onRequestEnd);\n    ds.subscribe(ChannelName.RequestError, this._onRequestError);\n  }\n\n  /** Helper that wraps shouldCreateSpanForRequest option */\n   _shouldCreateSpan(url) {\n    if (this._options.tracing === false || (this._options.tracing === undefined && !hasTracingEnabled())) {\n      return false;\n    }\n\n    if (this._options.shouldCreateSpanForRequest === undefined) {\n      return true;\n    }\n\n    const cachedDecision = this._createSpanUrlMap.get(url);\n    if (cachedDecision !== undefined) {\n      return cachedDecision;\n    }\n\n    const decision = this._options.shouldCreateSpanForRequest(url);\n    this._createSpanUrlMap.set(url, decision);\n    return decision;\n  }\n\n   __init4() {this._onRequestCreate = (message) => {\n    // eslint-disable-next-line deprecation/deprecation\n    if (!_optionalChain([getClient, 'call', _10 => _10(), 'optionalAccess', _11 => _11.getIntegration, 'call', _12 => _12(Undici)])) {\n      return;\n    }\n\n    const { request } = message ;\n\n    const stringUrl = request.origin ? request.origin.toString() + request.path : request.path;\n\n    const client = getClient();\n    if (!client) {\n      return;\n    }\n\n    if (isSentryRequestUrl(stringUrl, client) || request.__sentry_span__ !== undefined) {\n      return;\n    }\n\n    const clientOptions = client.getOptions();\n    const scope = getCurrentScope();\n    const isolationScope = getIsolationScope();\n    const parentSpan = getActiveSpan();\n\n    const span = this._shouldCreateSpan(stringUrl) ? createRequestSpan(parentSpan, request, stringUrl) : undefined;\n    if (span) {\n      request.__sentry_span__ = span;\n    }\n\n    const shouldAttachTraceData = (url) => {\n      if (clientOptions.tracePropagationTargets === undefined) {\n        return true;\n      }\n\n      const cachedDecision = this._headersUrlMap.get(url);\n      if (cachedDecision !== undefined) {\n        return cachedDecision;\n      }\n\n      const decision = stringMatchesSomePattern(url, clientOptions.tracePropagationTargets);\n      this._headersUrlMap.set(url, decision);\n      return decision;\n    };\n\n    if (shouldAttachTraceData(stringUrl)) {\n      const { traceId, spanId, sampled, dsc } = {\n        ...isolationScope.getPropagationContext(),\n        ...scope.getPropagationContext(),\n      };\n\n      const sentryTraceHeader = span ? spanToTraceHeader(span) : generateSentryTraceHeader(traceId, spanId, sampled);\n\n      const sentryBaggageHeader = dynamicSamplingContextToSentryBaggageHeader(\n        dsc ||\n          (span\n            ? getDynamicSamplingContextFromSpan(span)\n            : getDynamicSamplingContextFromClient(traceId, client, scope)),\n      );\n\n      setHeadersOnRequest(request, sentryTraceHeader, sentryBaggageHeader);\n    }\n  };}\n\n   __init5() {this._onRequestEnd = (message) => {\n    // eslint-disable-next-line deprecation/deprecation\n    if (!_optionalChain([getClient, 'call', _13 => _13(), 'optionalAccess', _14 => _14.getIntegration, 'call', _15 => _15(Undici)])) {\n      return;\n    }\n\n    const { request, response } = message ;\n\n    const stringUrl = request.origin ? request.origin.toString() + request.path : request.path;\n\n    if (isSentryRequestUrl(stringUrl, getClient())) {\n      return;\n    }\n\n    const span = request.__sentry_span__;\n    if (span) {\n      setHttpStatus(span, response.statusCode);\n      span.end();\n    }\n\n    if (this._options.breadcrumbs) {\n      addBreadcrumb(\n        {\n          category: 'http',\n          data: {\n            method: request.method,\n            status_code: response.statusCode,\n            url: stringUrl,\n          },\n          type: 'http',\n        },\n        {\n          event: 'response',\n          request,\n          response,\n        },\n      );\n    }\n  };}\n\n   __init6() {this._onRequestError = (message) => {\n    // eslint-disable-next-line deprecation/deprecation\n    if (!_optionalChain([getClient, 'call', _16 => _16(), 'optionalAccess', _17 => _17.getIntegration, 'call', _18 => _18(Undici)])) {\n      return;\n    }\n\n    const { request } = message ;\n\n    const stringUrl = request.origin ? request.origin.toString() + request.path : request.path;\n\n    if (isSentryRequestUrl(stringUrl, getClient())) {\n      return;\n    }\n\n    const span = request.__sentry_span__;\n    if (span) {\n      span.setStatus('internal_error');\n      span.end();\n    }\n\n    if (this._options.breadcrumbs) {\n      addBreadcrumb(\n        {\n          category: 'http',\n          data: {\n            method: request.method,\n            url: stringUrl,\n          },\n          level: 'error',\n          type: 'http',\n        },\n        {\n          event: 'error',\n          request,\n        },\n      );\n    }\n  };}\n}Undici.__initStatic();\n\nfunction setHeadersOnRequest(\n  request,\n  sentryTrace,\n  sentryBaggageHeader,\n) {\n  let hasSentryHeaders;\n  if (Array.isArray(request.headers)) {\n    hasSentryHeaders = request.headers.some(headerLine => headerLine === 'sentry-trace');\n  } else {\n    const headerLines = request.headers.split('\\r\\n');\n    hasSentryHeaders = headerLines.some(headerLine => headerLine.startsWith('sentry-trace:'));\n  }\n\n  if (hasSentryHeaders) {\n    return;\n  }\n\n  request.addHeader('sentry-trace', sentryTrace);\n  if (sentryBaggageHeader) {\n    request.addHeader('baggage', sentryBaggageHeader);\n  }\n}\n\nfunction createRequestSpan(\n  activeSpan,\n  request,\n  stringUrl,\n) {\n  const url = parseUrl(stringUrl);\n\n  const method = request.method || 'GET';\n  const data = {\n    'http.method': method,\n  };\n  if (url.search) {\n    data['http.query'] = url.search;\n  }\n  if (url.hash) {\n    data['http.fragment'] = url.hash;\n  }\n  // eslint-disable-next-line deprecation/deprecation\n  return _optionalChain([activeSpan, 'optionalAccess', _19 => _19.startChild, 'call', _20 => _20({\n    op: 'http.client',\n    origin: 'auto.http.node.undici',\n    description: `${method} ${getSanitizedUrlString(url)}`,\n    data,\n  })]);\n}\n\nexport { ChannelName, Undici, nativeNodeFetchintegration };\n//# sourceMappingURL=index.js.map\n"],"names":["ChannelName"],"mappings":"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","x_google_ignoreList":[0]}